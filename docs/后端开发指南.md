# åç«¯å¼€å‘æŒ‡å—

## é¡¹ç›®ç»“æ„

```
backend/
â”œâ”€â”€ server.js              # æœåŠ¡å…¥å£
â”œâ”€â”€ package.json           # ä¾èµ–é…ç½®
â”œâ”€â”€ routes/
â”‚   â””â”€â”€ robot.js          # APIè·¯ç”±
â”œâ”€â”€ controllers/
â”‚   â””â”€â”€ robotController.js # æ§åˆ¶å™¨
â””â”€â”€ data/
    â””â”€â”€ mockData.js       # æ¨¡æ‹Ÿæ•°æ® (ğŸ”Œ æ§½ä½)
```

## å¿«é€Ÿå¯åŠ¨

### å®‰è£…ä¾èµ–

```bash
cd backend
npm install
```

### å¯åŠ¨æœåŠ¡

```bash
npm start
```

æœåŠ¡å°†åœ¨ `http://localhost:3000` å¯åŠ¨ã€‚

### éªŒè¯æœåŠ¡

```bash
curl http://localhost:3000/api/health
```

é¢„æœŸå“åº”ï¼š
```json
{
  "success": true,
  "message": "Server is running",
  "timestamp": 1770003074514
}
```

## APIæ¥å£æ–‡æ¡£

### åŸºç¡€ä¿¡æ¯

- **åŸºç¡€URL**: `http://localhost:3000`
- **APIå‰ç¼€**: `/api`
- **å“åº”æ ¼å¼**: JSON
- **å­—ç¬¦ç¼–ç **: UTF-8

### é€šç”¨å“åº”æ ¼å¼

æˆåŠŸå“åº”ï¼š
```json
{
  "success": true,
  "data": { ... },
  "timestamp": 1706520000000
}
```

é”™è¯¯å“åº”ï¼š
```json
{
  "success": false,
  "error": "é”™è¯¯ä¿¡æ¯",
  "timestamp": 1706520000000
}
```

### æ¥å£åˆ—è¡¨

#### 1. å¥åº·æ£€æŸ¥

```http
GET /api/health
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "message": "Server is running",
  "timestamp": 1770003074514
}
```

#### 2. è·å–æœºå™¨äººçŠ¶æ€

```http
GET /api/robot/status
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": {
    "battery": 76,
    "speed": 0.3,
    "temperature": 29,
    "coordinates": {
      "lat": 40.195,
      "lon": 116.399
    }
  },
  "timestamp": 1770003074514
}
```

**å­—æ®µè¯´æ˜**:
| å­—æ®µ | ç±»å‹ | èŒƒå›´ | è¯´æ˜ |
|------|------|------|------|
| battery | number | 0-100 | ç”µé‡ç™¾åˆ†æ¯” |
| speed | number | 0-10 | é€Ÿåº¦ (m/s) |
| temperature | number | -20~60 | æœºå™¨äººæ¸©åº¦ (Â°C) |
| coordinates.lat | number | -90~90 | GPSçº¬åº¦ |
| coordinates.lon | number | -180~180 | GPSç»åº¦ |

#### 3. å‘é€æ§åˆ¶æŒ‡ä»¤

```http
POST /api/robot/control
Content-Type: application/json
```

**è¯·æ±‚æ–¹å¼1ï¼šæ–¹å‘æ§åˆ¶**
```json
{
  "command": "forward"
}
```

å¯ç”¨çš„commandå€¼ï¼š
- `forward` - å‰è¿›
- `backward` - åé€€
- `left` - å·¦è½¬
- `right` - å³è½¬
- `stop` - åœæ­¢

**è¯·æ±‚æ–¹å¼2ï¼šä½œä¸šæ“ä½œ**
```json
{
  "action": "irrigation"
}
```

å¯ç”¨çš„actionå€¼ï¼š
- `irrigation` - çŒæº‰
- `fertilize` - æ–½è‚¥
- `scan` - æ‰«æ
- `harvest` - æ”¶å‰²

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "executed": true,
  "command": "forward",
  "message": "æŒ‡ä»¤å·²å‘é€: å‰è¿›",
  "timestamp": 1770003074514
}
```

#### 4. è·å–ä¼ æ„Ÿå™¨æ•°æ®

```http
GET /api/sensors
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": {
    "soilHumidity": 65,
    "soilTemp": 22,
    "light": 8000,
    "airHumidity": 55
  },
  "timestamp": 1770003074514
}
```

**å­—æ®µè¯´æ˜**:
| å­—æ®µ | ç±»å‹ | èŒƒå›´ | è¯´æ˜ |
|------|------|------|------|
| soilHumidity | number | 0-100 | åœŸå£¤æ¹¿åº¦ (%) |
| soilTemp | number | -10~50 | åœŸå£¤æ¸©åº¦ (Â°C) |
| light | number | 0-100000 | å…‰ç…§å¼ºåº¦ (Lux) |
| airHumidity | number | 0-100 | ç©ºæ°”æ¹¿åº¦ (%) |

#### 5. è·å–ä»»åŠ¡åˆ—è¡¨

```http
GET /api/tasks
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "name": "AåŒºçŒæº‰ä½œä¸š",
      "status": "active",
      "progress": 45
    },
    {
      "id": 2,
      "name": "BåŒºç—…è™«å®³æ£€æµ‹",
      "status": "pending",
      "progress": 0
    }
  ],
  "timestamp": 1770003074514
}
```

**å­—æ®µè¯´æ˜**:
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | number | ä»»åŠ¡å”¯ä¸€æ ‡è¯† |
| name | string | ä»»åŠ¡åç§° |
| status | string | `active`(è¿›è¡Œä¸­) / `pending`(ç­‰å¾…) / `done`(å®Œæˆ) |
| progress | number | è¿›åº¦ 0-100 |

#### 6. è·å–ä½œä¸šç»Ÿè®¡

```http
GET /api/statistics
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": {
    "completedArea": 12.5,
    "totalArea": 38.2,
    "progress": 32.7
  },
  "timestamp": 1770003074514
}
```

**å­—æ®µè¯´æ˜**:
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| completedArea | number | å·²å®Œæˆé¢ç§¯ (äº©) |
| totalArea | number | æ€»é¢ç§¯ (äº©) |
| progress | number | å®Œæˆè¿›åº¦ (%) |

## CORSé…ç½®

æœåŠ¡å™¨å·²å¯ç”¨CORSï¼Œå…è®¸è·¨åŸŸè¯·æ±‚ï¼š

```javascript
app.use(cors({
    origin: '*',
    methods: ['GET', 'POST', 'PUT', 'DELETE'],
    allowedHeaders: ['Content-Type', 'Authorization']
}));
```

## æ—¥å¿—ç³»ç»Ÿ

### æ—¥å¿—æ–‡ä»¶

æ—¥å¿—è‡ªåŠ¨å†™å…¥ `backend.log` æ–‡ä»¶ã€‚

### æ—¥å¿—çº§åˆ«

- **INFO**: å¸¸è§„ä¿¡æ¯
- **ERROR**: é”™è¯¯ä¿¡æ¯
- **DEBUG**: è°ƒè¯•ä¿¡æ¯

### æŸ¥çœ‹æ—¥å¿—

```bash
# Windows
type backend\backend.log

# Linux/Mac
tail -f backend/backend.log
```

## å¯¹æ¥çœŸå®ç¡¬ä»¶

åç«¯ä»£ç ä¸­æ ‡è®°äº† `ğŸ”Œ SLOT` çš„ä½ç½®æ˜¯éœ€è¦å¯¹æ¥çœŸå®ç¡¬ä»¶çš„æ§½ä½ã€‚

### æ–¹å¼1: ç›´æ¥æ›¿æ¢æ¨¡æ‹Ÿæ•°æ®

ä¿®æ”¹ `backend/data/mockData.js`ï¼š

```javascript
// ğŸ”Œ SLOT: ä»çœŸå®ç¡¬ä»¶è¯»å–
function getRobotStatus() {
    // æ›¿æ¢ä¸ºçœŸå®ç¡¬ä»¶é©±åŠ¨
    return hardwareDriver.getStatus();
}
```

### æ–¹å¼2: ä½¿ç”¨MQTTåè®®

æ¨èä½¿ç”¨MQTTåè®®ä¸ç¡¬ä»¶é€šä¿¡ã€‚è¯¦è§ [MQTTæ¥å£æ–‡æ¡£](./MQTTæ¥å£æ–‡æ¡£.md)ã€‚

## æŠ€æœ¯æ ˆ

- **Node.js** 14+
- **Express** 4.x - Webæ¡†æ¶
- **CORS** - è·¨åŸŸæ”¯æŒ
- **Morgan** - HTTPè¯·æ±‚æ—¥å¿—
- **MQTT** - ç‰©è”ç½‘é€šä¿¡åè®®ï¼ˆå¯é€‰ï¼‰

## å¼€å‘å»ºè®®

### ä»£ç ç»„ç»‡

- **routes/** - è·¯ç”±å®šä¹‰ï¼Œå¤„ç†HTTPè¯·æ±‚
- **controllers/** - ä¸šåŠ¡é€»è¾‘ï¼Œå¤„ç†æ•°æ®
- **data/** - æ•°æ®æºï¼ˆæ¨¡æ‹Ÿæ•°æ®æˆ–ç¡¬ä»¶æ¥å£ï¼‰

### é”™è¯¯å¤„ç†

ç»Ÿä¸€ä½¿ç”¨try-catchå¤„ç†é”™è¯¯ï¼š

```javascript
try {
    const data = await getDataFromHardware();
    res.json({ success: true, data });
} catch (error) {
    logger.error('Error:', error);
    res.status(500).json({ 
        success: false, 
        error: error.message 
    });
}
```

### æ€§èƒ½ä¼˜åŒ–

- ä½¿ç”¨ç¼“å­˜å‡å°‘ç¡¬ä»¶æŸ¥è¯¢
- åˆç†è®¾ç½®è¶…æ—¶æ—¶é—´
- é¿å…é˜»å¡ä¸»çº¿ç¨‹

## éƒ¨ç½²è¯´æ˜

### å¼€å‘ç¯å¢ƒ

```bash
npm start
```

### ç”Ÿäº§ç¯å¢ƒ

```bash
# ä½¿ç”¨PM2ç®¡ç†è¿›ç¨‹
npm install -g pm2
pm2 start server.js --name robot-backend

# æŸ¥çœ‹çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs robot-backend
```

### ç¯å¢ƒå˜é‡

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```
PORT=3000
NODE_ENV=production
MQTT_BROKER=mqtt://localhost:1883
```

## è°ƒè¯•æŠ€å·§

### 1. æµ‹è¯•å•ä¸ªAPI

```bash
# GETè¯·æ±‚
curl http://localhost:3000/api/robot/status

# POSTè¯·æ±‚
curl -X POST http://localhost:3000/api/robot/control \
  -H "Content-Type: application/json" \
  -d '{"command":"forward"}'
```

### 2. å¯ç”¨è°ƒè¯•æ¨¡å¼

```bash
# Windows
set DEBUG=* && npm start

# Linux/Mac
DEBUG=* npm start
```

### 3. ä½¿ç”¨Postman

å¯¼å…¥é¡¹ç›®æä¾›çš„Postmanæµ‹è¯•é›†åˆï¼Œå¿«é€Ÿæµ‹è¯•æ‰€æœ‰APIã€‚

## å¸¸è§é—®é¢˜

### Q: ç«¯å£è¢«å ç”¨æ€ä¹ˆåŠï¼Ÿ

```bash
# æŸ¥æ‰¾å ç”¨ç«¯å£çš„è¿›ç¨‹
netstat -ano | findstr :3000

# åœæ­¢è¿›ç¨‹
taskkill /PID <è¿›ç¨‹ID> /F

# æˆ–ä¿®æ”¹ç«¯å£
# åœ¨server.jsä¸­ä¿®æ”¹ const PORT = 3001;
```

### Q: å¦‚ä½•ä¿®æ”¹APIç«¯å£ï¼Ÿ

ä¿®æ”¹ `server.js`ï¼š
```javascript
const PORT = process.env.PORT || 3001;
```

åŒæ—¶ä¿®æ”¹å‰ç«¯ `config.js`ï¼š
```javascript
BASE_URL: 'http://localhost:3001'
```

### Q: å¦‚ä½•æ·»åŠ æ–°çš„APIç«¯ç‚¹ï¼Ÿ

1. åœ¨ `routes/robot.js` æ·»åŠ è·¯ç”±
2. åœ¨ `controllers/robotController.js` æ·»åŠ æ§åˆ¶å™¨æ–¹æ³•
3. æ›´æ–°APIæ–‡æ¡£

---

**åç«¯å¼€å‘æ–‡æ¡£**
